---
name: Deployment Configuration
status: open
created: 2025-09-03T12:09:35Z
updated: 2025-09-03T12:38:22Z
github: https://github.com/Shannon-x/vps/issues/11
depends_on: ["10"]
parallel: false
conflicts_with: []
---

# Deployment Configuration

## Overview
Configure PM2 process management and optimize Nginx for production deployment.

## Requirements

### PM2 Configuration
1. Process Management
   - Cluster mode configuration
   - Auto-restart on failure
   - Memory limit management
   - Log rotation setup

2. Monitoring
   - CPU and memory usage tracking
   - Error rate monitoring
   - Request metrics
   - Health check endpoints

### Nginx Optimization
1. Performance Tuning
   - Worker process optimization
   - Connection limits
   - Buffer sizes
   - Gzip compression

2. Security Hardening
   - Rate limiting
   - DDoS protection
   - SSL/TLS optimization
   - Security headers

## Technical Implementation

### PM2 Ecosystem File
```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'vps-platform',
    script: '.output/server/index.mjs',
    instances: 'max',
    exec_mode: 'cluster',
    autorestart: true,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: 'logs/pm2-error.log',
    out_file: 'logs/pm2-out.log',
    log_file: 'logs/pm2-combined.log',
    time: true
  }]
};
```

### Nginx Configuration
```nginx
# nginx.conf optimization
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
}
```

### Health Check Implementation
```javascript
// Health check endpoint
app.get('/health', (req, res) => {
  const healthcheck = {
    uptime: process.uptime(),
    message: 'OK',
    timestamp: Date.now(),
    checks: {
      database: await checkDatabase(),
      redis: await checkRedis(),
      memory: process.memoryUsage()
    }
  };
  res.status(200).send(healthcheck);
});
```

### Deployment Script
```bash
#!/bin/bash
# deploy.sh
echo "Starting deployment..."

# Build application
npm run build

# Run database migrations
npm run migrate

# Restart PM2
pm2 reload ecosystem.config.js

# Reload Nginx
nginx -t && nginx -s reload

echo "Deployment complete!"
```

## Monitoring Setup
1. PM2 Monitoring
   - Enable PM2 Plus for advanced monitoring
   - Configure alerts for crashes
   - Set up log aggregation

2. System Monitoring
   - Server resource monitoring
   - Application performance monitoring
   - Error tracking integration
   - Uptime monitoring

## Acceptance Criteria
- [ ] PM2 cluster mode is configured
- [ ] Auto-restart on failure works
- [ ] Nginx is optimized for performance
- [ ] Security headers are implemented
- [ ] Health check endpoints respond correctly
- [ ] Deployment script executes successfully
- [ ] Monitoring alerts are configured

## Dependencies
- Task 10: Performance optimization must be complete

## Notes
- Consider implementing blue-green deployment
- Add automated backup procedures
- Configure log shipping to central location
- Implement graceful shutdown handling
- Document rollback procedures